--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
MoveableDoors = MoveableDoors or {}
--[[
    SandboxVars.MoveableDoors.WoodworkReqXP or 5
    SandboxVars.MoveableDoors.MetalWeldingReqXP or 3
    SandboxVars.MoveableDoors.MustHaveKey or false
    SandboxVars.MoveableDoors.DismantleDuration or 200
    SandboxVars.MoveableDoors.TimeReductionBonus or 3
    SandboxVars.MoveableDoors.SuccessRate or 45
    SandboxVars.MoveableDoors.SuccessRateBonus or 3
    SandboxVars.MoveableDoors.CanChangeKeyId or true
 ]]
--  inv:haveThisKeyId(padlockedThump:getKeyId())

-----------------------            ---------------------------

function MoveableDoors.setKeyId(door)
    local function setKeyId(target, button, door)
        if button.internal ~= "OK" then return end
        local KeyId = tonumber(button.parent.entry:getText())
        if not KeyId then return end

        if not MoveableDoors.haveDoorKey(door, getPlayer()) then
            local key = InventoryItemFactory.CreateItem("Base.Key1")
            key:setKeyId(KeyId)
            door:getSquare():AddWorldInventoryItem(key, 0.5, 0.5, 0)
        end

        door:setKeyId(KeyId)
        for _, obj in ipairs(buildUtil.getDoubleDoorObjects(door)) do
            obj:setKeyId(KeyId)
        end
        for _, obj in ipairs(buildUtil.getGarageDoorObjects(door)) do
            obj:setKeyId(KeyId)
        end

    end

    local modal = ISTextBox:new(0, 0, 280, 180, "Key ID:", tostring(door:getKeyId()), nil, setKeyId, nil, door)
    modal:initialise()
    modal:addToUIManager()
end

-----------------------            ---------------------------
function MoveableDoors.getDoorItemKeyId(doorItem)
    if doorItem:getModData() then
        return doorItem:getModData()['KeyId']
    end
    return nil
end

function MoveableDoors.getDoorItemSprName(doorItem)
    if doorItem:getModData() then
        return doorItem:getModData()['PackedSpr']
    end
    return nil
end

function MoveableDoors.haveDoorItemKey(doorItem, pl)
    return pl:getInventory():haveThisKeyId(MoveableDoors.getDoorItemKeyId(doorItem))
end
-----------------------            ---------------------------


function MoveableDoors.getDoorItemSprName(doorItem)
    if doorItem:getModData() then
        return doorItem:getModData()['PackedSpr']
    end
    return nil
end

function MoveableDoors.setDoorItemSprName(doorItem, sprName)
    doorItem:getModData()['PackedSpr'] = sprName
end


--[[ function MoveableDoors.isDoubleDoor(door)
    if not door or not door:getSprite() then return false, false end
    local props = door:getSprite():getProperties()
    local isDoubleDoor = props and props:Is("DoubleDoor")
    return isDoubleDoor
end


function MoveableDoors.isGarageDoor(door)
    if not door or not door:getSprite() then return false, false end
    local props = door:getSprite():getProperties()
    local isGarageDoor = props and props:Is("GarageDoor")
    return isGarageDoor
end ]]
--[[

function MoveableDoors.doorRemoved(door)
    local props = door:getSprite():getProperties()
    local isGarageDoor, isDoubleDoor
    if instanceof(door, "IsoDoor")   then
        local spr = door:getSprite()
        local props spr:getProperties()
        if props then
            isGarageDoor = props:Is("GarageDoor")
            isDoubleDoor = props:Is("DoubleDoor")
        end
        local sq = door:getSquare()
        if not sq then
            return
        end

        if isGarageDoor then
            for _, doorPart in ipairs(buildUtil.getGarageDoorObjects(door)) do
                local doorPartSprName = doorPart:getSprite():getName()
                local spawnFType = "Base.GarageDoorPackage"
                local doorItem = sq:AddWorldInventoryItem(tostring(spawnFType), 0.5, 0.5, 0)
                MoveableDoors.setDoorItemSprName(doorItem, doorPartSprName)
            end

        elseif isDoubleDoor then
            for _, doorPart in ipairs(buildUtil.getDoubleDoorObjects(door)) do
                local doorPartSprName = doorPart:getSprite():getName()
                local spawnFType = "Base.DoubleDoorPackage"
                local doorItem = sq:AddWorldInventoryItem(tostring(spawnFType), 0.5, 0.5, 0)
                MoveableDoors.setDoorItemSprName(doorItem, doorPartSprName)
            end
        end

    end
    if MoveableDoors.hasAccess(door, getPlayer())  then
    end
end
 ]]
--Events.OnTileRemoved.Add(MoveableDoors.doorRemoved)
--Events.OnObjectAboutToBeRemoved.Add(MoveableDoors.doorRemoved)


-----------------------            ---------------------------


-----------------------            ---------------------------
function MoveableDoors.isGarageDoor(obj)
    return obj and obj:getProperties() and obj:getProperties():Is("GarageDoor")
end
function MoveableDoors.isDoubleDoor(obj)
    return obj and obj:getProperties() and obj:getProperties():Is("DoubleDoor")
end
function MoveableDoors.getBldgKeyId(sq)
    return sq:getBuilding():getDef():getKeyId()
end




-----------------------            ---------------------------
--[[
local spr = obj:getSprite()
if spr then
    local sprName = spr:getName()
    if sprName then
        local isMultiTile = getSprite(sprName):getSpriteGrid()
        local props = obj:getProperties()
        if props and isMultiTile then
            isGarageDoor = props:Is("GarageDoor")
            isDoubleDoor = props:Is("DoubleDoor")
            if isGarageDoor or isDoubleDoor then
                local isLocked = obj:isLocked()
                local isBarricaded = obj:isBarricaded()
                local haveKey = MoveableDoors.haveDoorKey(obj, pl)
                if (not isLocked or haveKey) and not isBarricaded then
                    isValid = true
                    break
                else
                    print('no access')
                end
            end
        end
    end
    print(door)
end
]]
-----------------------            ---------------------------
--[[
function buildUtil.getDoubleDoorObjects(object)
	local objects = {}
	for i=1,4 do
		local dd = IsoDoor.getDoubleDoorObject(object, i)
		if dd then
			table.insert(objects, dd)
		end
	end
	return objects
end

function buildUtil.getGarageDoorObjects(object)
	local objects = {}
	if IsoDoor.getGarageDoorIndex(object) ~= -1 then
		table.insert(objects, object)
		local prev = IsoDoor.getGarageDoorPrev(object)
		while prev do
			table.insert(objects, prev)
			prev = IsoDoor.getGarageDoorPrev(prev)
		end
		local next = IsoDoor.getGarageDoorNext(object)
		while next do
			table.insert(objects, next)
			next = IsoDoor.getGarageDoorNext(next)
		end
	end
	return objects
end
 ]]

--[[
function MoveableDoors.worldContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    if not sq then return end
    if test then return true end

    local doorObjects = {}

    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        if instanceof(obj, "IsoDoor") or (instanceof(obj, "IsoThumpable") and obj:isDoor()) then
            table.insert(doorObjects, obj)
        end
    end

    if #doorObjects > 0 then
        local disassembleContext = ISContextMenu:getNew(context)
        local option = context:addOption(getText("ContextMenu_Disassemble_Door"), worldobjects)
        context:addSubMenu(option, disassembleContext)

        for _, door in ipairs(doorObjects) do
            local caption = door:isGarageDoor() and getText("ContextDisassemble_GarageDoor") or getText("ContextMenu_Disassemble_DoubleDoor")
            disassembleContext:addOption(tostring(caption), worldobjects, MoveableDoors.disassembleDoor, pl, sq, door)
        end
    end
end

function MoveableDoors.disassembleDoor(player, square, door)
    if player:isPerformingAnAction() then return end
    if not square or not door then return end

    local isDoubleOrGarageDoor = door:isGarageDoor() or door:isDoubleDoor()
    ISTimedActionQueue.add(ISDisassembleDoor:new(player, square, door, isDoubleOrGarageDoor))
end

Events.OnPreFillWorldObjectContextMenu.Remove(MoveableDoors.worldContext)
Events.OnFillWorldObjectContextMenu.Add(MoveableDoors.worldContext)
 ]]
   --[[
    if sq then
        for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if instanceof(obj, "IsoDoor") then -- and MoveableDoors.hasAccess(obj, pl) then
                door = obj
                break
            end
        end

        local caption
        if door and instanceof(door, "IsoDoor")  then
            if isGarageDoor then
                caption = 'Take Garage Door'
            elseif isDoubleDoor then
                caption = 'Take Double Door'
            end
            if caption then
                local optTip = context:addOptionOnTop(tostring(caption), worldobjects, function()

                end)
            end

            local optTip = context:addOptionOnTop(tostring(caption), worldobjects, function()

            end)
        end

    end
   -- print('test')
end


Events.OnFillWorldObjectContextMenu.Remove(MoveableDoors.worldContext)
Events.OnFillWorldObjectContextMenu.Add(MoveableDoors.worldContext)

]]
-----------------------            ---------------------------


--[[
		local tip = ISWorldObjectContextMenu.addToolTip()
		tip.description = ""
		tip:setName("MoveableDoors: ")
        local iconPath = "media/ui/chop_tree.png"
        optTip.iconTexture = getTexture(iconPath)
        tip:setTexture(iconPath)


		optTip.toolTip = tip
		optTip.notAvailable = true
        ]]

