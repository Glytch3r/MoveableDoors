--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


MoveableDoors = MoveableDoors or {}
-----------------------            ---------------------------
require "TimedActions/ISBaseTimedAction"

MoveableDoorsAction = ISBaseTimedAction:derive("MoveableDoorsAction")

local function predicateNotBroken(item)
    return not item:isBroken()
end
function MoveableDoorsAction:update()
    self.character:faceThisObject(self.door)
end
--[[
function MoveableDoorsAction:isValid()
    local reqKey = SandboxVars.MoveableDoors.MustHaveKey or false
    if (reqKey and MoveableDoors.haveDoorKey(self.door, self.character)) or
       (not reqKey and MoveableDoors.hasSkills(self.character)) then
        self.sq = self.door:getSquare()
        return self.door and self.sq and self.sq:DistToSquared(self.character:getSquare()) < 4
    end
    return false
end
 ]]
function MoveableDoorsAction:isValid()
    return true
end

function MoveableDoorsAction:start()
    self:setActionAnim("Loot")
    self.character:PlayAnim("Loot")
    self.character:SetVariable("LootPosition", "Mid")
end


function MoveableDoorsAction:waitToStart()
    self.character:faceThisObject(self.door)
    return self.character:shouldBeTurning()
end


function MoveableDoorsAction:stop()
    ISBaseTimedAction.stop(self)
end

function MoveableDoorsAction.doSledge(obj)
    if isClient() then
        sledgeDestroy(obj)
    else
        local sq = obj:getSquare()
        if sq then
            sq:RemoveTileObject(obj);
            sq:getSpecialObjects():remove(obj);
            sq:getObjects():remove(obj);
            sq:transmitRemoveItemFromSquare(obj)
        end
    end
end

function MoveableDoorsAction:perform()


    local roll = MoveableDoors.doRoll()
    if not roll then return end

    local props = self.door:getProperties()
    local isGarageDoor = props and props:Is("GarageDoor")
    local isDoubleDoor = props and props:Is("DoubleDoor")
    local doorParts = {}

    if isGarageDoor then
        doorParts = buildUtil.getGarageDoorObjects(self.door)
    elseif isDoubleDoor then
        doorParts = buildUtil.getDoubleDoorObjects(self.door)
    else
        table.insert(doorParts, self.door)
    end

    local toSpawn = isGarageDoor and "Base.GarageDoorPackage" or "Base.DoubleDoorPackage"

    for _, obj in ipairs(doorParts) do
        local spr = obj:getSprite()
        local sprName = spr and spr:getName() or "Unknown"
        local sq =  obj:getSquare()
        MoveableDoorsAction.doSledge(obj)
        --[[
        sq:transmitRemoveItemFromSquare(obj)
        obj:getCell():removeIsoObject(obj)
 ]]
        local doorItem = sq:AddWorldInventoryItem(toSpawn, 0.5, 0.5, 0)
        if doorItem then
            doorItem:getModData()["PackedSpr"] = sprName
        end
    end
    local newKey = self.character:AddWorldInventoryItem("Base.Key1", 0.5, 0.5, 0)
    newKey:setKeyId(-1)
    ISBaseTimedAction.perform(self)
end

function MoveableDoorsAction:new(character, door, sq, time)
    local o = {}
    setmetatable(o, self)
    self.__index = self
    o.character = character
    o.door = door
    o.stopOnWalk = false
    o.sq = sq
    o.stopOnRun = true
    o.maxTime = time
    o.isGarageDoor = door:getProperties():Is("GarageDoor")
    o.isDoubleDoor = door:getProperties():Is("DoubleDoor")
    return o
end

function MoveableDoors.doRoll()
    local SuccessRate = SandboxVars.MoveableDoors.SuccessRate or 15;
    local boost = SandboxVars.MoveableDoors.SuccessRateBonus or 3;
    local levelMult =  MoveableDoors.getLevelMult()
    local roll = math.max(0, math.min(100, SuccessRate + (boost * levelMult)))
    if roll >= 100 then return true end
    if roll <= 0 then return false end
    return roll >= ZombRand(1, 101)
end

function MoveableDoors.canTakeDoors(pl, door)
    if not MoveableDoors.hasSkills(pl) then return false end
    local reqKey = SandboxVars.MoveableDoors.MustHaveKey or false
    if reqKey and not MoveableDoors.haveDoorKey(door, pl) then return false end
end

function MoveableDoors.context(player, context, worldobjects, test)
	local pl = getSpecificPlayer(player)
	local sq = clickedSquare
	if sq then
        local door = MoveableDoors.getDoor(sq)
        if door then
            local optTip = context:addOptionOnTop('Take Door', worldobjects, function()
                if luautils.walkAdj(pl, sq) then
                    --ISTimedActionQueue.add(ISWalkToTimedAction:new(pl, sq));
                    local maxTime = MoveableDoors.getMaxTime()
                    ISTimedActionQueue.add(MoveableDoorsAction:new(pl, door, door:getSquare(), maxTime));
                end
                getSoundManager():playUISound("UIActivateMainMenuItem")
            end)
            optTip.iconTexture = getTexture("media/ui/HodorIcon.png")
            if not (MoveableDoors.isGarageDoor(door) or MoveableDoors.isDoubleDoor(door)) then
                optTip.notAvailable = true
            end
        end
	end
end
Events.OnFillWorldObjectContextMenu.Remove(MoveableDoors.context)
Events.OnFillWorldObjectContextMenu.Add(MoveableDoors.context)

function MoveableDoors.getMaxTime()
    local pl = getPlayer()
    local dur            = SandboxVars.MoveableDoors.DismantleDuration or 200
    local TimeReductionBonus = SandboxVars.MoveableDoors.TimeReductionBonus or 3
    local LevelMult =  MoveableDoors.getLevelMult()
    return tonumber(math.max(50, dur - (TimeReductionBonus * LevelMult)))
end


function MoveableDoors.getLevelMult()
    local pl = getPlayer()
    local WoodworkLevel = pl:getPerkLevel(Perks.Woodwork)
    local MetalWeldingLevel = pl:getPerkLevel(Perks.MetalWelding)
    local requiredLevel1 = SandboxVars.MoveableDoors.WoodworkReqXP or 5
    local requiredLevel2 = SandboxVars.MoveableDoors.MetalWeldingReqXP or 3
    return tonumber(math.max(0, (WoodworkLevel - requiredLevel1)) + math.max(0, (MetalWeldingLevel - requiredLevel2)))
end

function MoveableDoors.hasSkills(pl)
    pl = pl or getPlayer()
    local WoodworkReqXP = SandboxVars.MoveableDoors.WoodworkReqXP or 5
    local MetalWeldingReqXP = SandboxVars.MoveableDoors.MetalWeldingReqXP or 3
    return WoodworkReqXP <= pl:getPerkLevel(Perks.Woodwork) and MetalWeldingReqXP <= pl:getPerkLevel(Perks.MetalWelding)
end
function MoveableDoors.haveDoorKey(door, pl)
    pl = pl or getPlayer()
    local KeyId = instanceof(door, "IsoDoor") and door:checkKeyId() or door:getKeyId()
    return pl:getInventory():haveThisKeyId(KeyId)
end
