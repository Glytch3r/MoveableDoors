--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
MoveableDoors = MoveableDoors or {}

 -----------------------            ---------------------------
--[[
        NOTE to other modders:

        MoveableDoors.getAltFace function is insane it was hard to figure out
        good thing i noticed the pattern
        WestSprites = {0, 1, 2}
        NorthSprites = {3, 4, 5}

        for double doors its different it alternates

        so this will work for vanilla tiles but it might not work for non vanilla
        if they dont use the same pattern as vanilla tile positions

        and so
        if you plan to make your garagedoor or double door compatible with this mod
        then copy the vanilla tiles pattern

 ]]

function MoveableDoors.getAltFace(sprName, isGarage)
    local doorParts = {}
    for part in string.gmatch(sprName, "([^_]+)") do
        table.insert(doorParts, part)
    end
    local partsCount = #doorParts
    local lastPart = tonumber(doorParts[partsCount])
    if not lastPart then return sprName end

    if isGarage then
        local col = lastPart % 6
        if col >= 0 and col <= 2 then
            doorParts[partsCount] = tostring(lastPart + 3)
        elseif col >= 3 and col <= 5 then
            doorParts[partsCount] = tostring(lastPart - 3)
        end
    else --elseif isDouble then
        if lastPart % 2 == 0 then
            doorParts[partsCount] = tostring(lastPart + 1)
        else
            doorParts[partsCount] = tostring(lastPart - 1)
        end
    end

    return table.concat(doorParts, "_")
end

-----------------------            ---------------------------
function MoveableDoors.isKey(fType)
    local tab = {
        ["Base.Key1"] = true,
        ["Base.Key2"] = true,
        ["Base.Key3"] = true,
        ["Base.Key4"] = true,
        ["Base.Key5"] = true,
    }
    return tab[fType]
end
function MoveableDoors.hasValidKeysInHands(pl)
    pl = pl or {}
    local pr = pl:getPrimaryHandItem()
    local sc = pl:getSecondaryHandItem()
    if pr or sc then
        return (MoveableDoors.isKey(pr:getFullType()) and pr:getKeyId() ~= -1)  or
            ( sc and MoveableDoors.isKey(sc:getFullType()) and sc:getKeyId() ~= -1)
    end
end

--[[ function MoveableDoors.copyKeyId(pl)
    pl = pl or getPlayer()
    local pr = pl:getPrimaryHandItem()
    local sc = pl:getSecondaryHandItem()

    if pr and sc and MoveableDoors.isKey(pr:getFullType()) and MoveableDoors.isKey(sc:getFullType()) then
        if pr:getKeyId() ~= -1 and sc:getKeyId() == -1 then
            sc:setKeyId(pr:getKeyId()) -- to left
        elseif pr:getKeyId() == -1 and sc:getKeyId() ~= -1 then
            pr:setKeyId(sc:getKeyId()) -- to right
        end
    end
    pl:getInventory():setDirty(true)
end ]]
function MoveableDoors.invContext(player, context, items)
    local pl = getSpecificPlayer(player)
    local isGarage = false
    local doorItem = nil
    local keyItem = nil

    for _, item in ipairs(items) do
        local checkItem = type(item) == "table" and item.items[1] or (instanceof(item, "InventoryItem") and item or nil)
        if checkItem then
            local fType = checkItem:getFullType()
            local KeyId = checkItem:getKeyId()
            if fType then
                if fType == "Base.GarageDoorPackage" then
                    doorItem = checkItem
                    isGarage = true
                elseif fType == "Base.DoubleDoorPackage" then
                    doorItem = checkItem
                elseif MoveableDoors.isKey(fType) and MoveableDoors.hasValidKeysInHands(pl) and checkItem:getKeyId() == -1 then
                    keyItem = checkItem
                end
            end
        end
    end

    if keyItem and (SandboxVars.MoveableDoors.CanChangeKeyId or getCore():getDebug()) then
        if MoveableDoors.hasValidKeysInHands(pl) then
            local sc = pl:getSecondaryHandItem()
            local pr = pl:getPrimaryHandItem()

            local optCopyKeyLeft, optCopyKeyRight

            if sc and sc:getKeyId() ~= -1 then
                optCopyKeyLeft = context:addOptionOnTop("Copy Key Id from Left hand key", nil, function()
                    keyItem:setKeyId(sc:getKeyId())
                end)
            end

            if pr and pr:getKeyId() ~= -1 then
                optCopyKeyRight = context:addOptionOnTop("Copy Key Id from Right hand key", nil, function()
                    keyItem:setKeyId(pr:getKeyId())
                end)
            end

            if optCopyKeyLeft and sc and sc:getKeyId() == -1 then
                optCopyKeyLeft.notAvailable = true
                local tip = ISInventoryPaneContextMenu.addToolTip()
                tip.description = "Invalid Id Left Hand Key"
                optCopyKeyLeft.toolTip = tip
            end

            if optCopyKeyRight and pr and pr:getKeyId() == -1 then
                optCopyKeyRight.notAvailable = true
                local tip = ISInventoryPaneContextMenu.addToolTip()
                tip.description = "Invalid Id Right Hand Key"
                optCopyKeyRight.toolTip = tip
            end
        end
    elseif doorItem then
        local cap = isGarage and "Place Garage Door Part" or "Place Double Door Part"
        context:addOptionOnTop(cap, nil, function()
            local sprName = MoveableDoors.getDoorItemSprName(doorItem)
            local altSprName = MoveableDoors.getAltFace(sprName, isGarage)
            local cursor = ISBrushToolTileCursor:new(sprName, altSprName, pl)
            getCell():setDrag(cursor, 0)
            pl:getInventory():Remove(doorItem)
            ISInventoryPage.renderDirty = true
            ISInventoryPage.dirtyUI()
            ISMoveableCursor.clearCacheForAllPlayers()
        end)
    end
end
Events.OnFillInventoryObjectContextMenu.Remove(MoveableDoors.invContext)
Events.OnFillInventoryObjectContextMenu.Add(MoveableDoors.invContext)
-----------------------            ---------------------------
--[[
function MoveableDoors.getPlacedDoor(sq, sprName)
    if not sq then return false end

    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        if obj:getSprite() and obj:getSprite():getName() == sprName then
            return obj
        end
    end

    return false
end
 ]]
--[[
function MoveableDoors.setDoorItemKeyId(doorItem)
    local function setKeyId(target, button, doorItem)
        if button.internal ~= "OK" then return end
        local KeyId = tonumber(button.parent.entry:getText())
        if not KeyId then return end
        doorItem:getModData()['KeyId'] = KeyId
    end

    local modal = ISTextBox:new(0, 0, 280, 180, "Key ID:", tostring( MoveableDoors.getDoorItemKeyId(doorItem)), nil, setKeyId, nil, doorItem)
    modal:setOnlyNumbers(true)
    modal:initialise()
    modal:addToUIManager()
end
 ]]

--[[
function MoveableDoors.invContext(player, context, items)
    local pl = getSpecificPlayer(player)
    local sq = pl:getSquare();
    local isGarage = false
    local doorItem = nil
    local keyItem = nil
    local copyFromItem = nil
    for i, item in ipairs(items) do
        local checkItem
        if type(item) == "table" then
            checkItem = item.items[1]
        elseif instanceof(item, "InventoryItem") then
            checkItem = item
        end
        if checkItem then
            local fType = checkItem:getFullType()
            local KeyId = checkItem:getKeyId()
            if fType then
                if fType == "Base.GarageDoorPackage" then
                    doorItem = checkItem
                    isGarage = true
                elseif fType == "Base.DoubleDoorPackage" then
                    doorItem = checkItem
                elseif MoveableDoors.isKey(fType) and KeyId and KeyId == -1 then
                    keyItem = checkItem
                end
            end
        end
    end
    if keyItem and (SandboxVars.MoveableDoors.CanChangeKeyId or getCore():getDebug()) then
        local pr = pl:getPrimaryHandItem()
        if pr and MoveableDoors.isKey(pr:getFullType()) then
            copyFromItem = pr
            local optKey = context:addOptionOnTop("Copy Key Id", nil, function()
                keyItem:setKeyId(copyFromItem:getKeyId())
            end)

            if WeaponType.getWeaponType(pl) ~= 'barehand' then
                optKey.notAvailable = true
                local tip = ISInventoryPaneContextMenu.addToolTip()
                tip.description = "Equip a key in your right hand to copy"
                optKey.toolTip = tip
            end
        end
    elseif doorItem then
        --local KeyId = tonumber(doorItem:getModData()['KeyId'])
        -----------------------            ---------------------------
        local cap = "Place Double Door Part"
        if isGarage then cap = "Place Garage Door Part" end
        context:addOptionOnTop(tostring(cap), worldobjects, function()
            local sprName = MoveableDoors.getDoorItemSprName(doorItem)
            local altSprName = MoveableDoors.getAltFace(sprName, isGarage)
            local cursor = ISBrushToolTileCursor:new(sprName,  altSprName,  pl)
            getCell():setDrag(cursor, 0)
            local inv = pl:getInventory()
            print(doorItem)
            inv:Remove(doorItem)
            ISInventoryPage.renderDirty = true
            ISInventoryPage.dirtyUI();
            ISMoveableCursor.clearCacheForAllPlayers();
        end)

        -----------------------            ---------------------------
    end

end
Events.OnFillInventoryObjectContextMenu.Remove(MoveableDoors.invContext)
Events.OnFillInventoryObjectContextMenu.Add(MoveableDoors.invContext) ]]
-----------------------            ---------------------------